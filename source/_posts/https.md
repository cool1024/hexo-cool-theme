---
title: https证书获取与配置（nginx）
date: 2018-08-14 15:04:35
tags: [nginx,https]
---

#### 使用git克隆项目到`/var/www`目录下
1. Clone with SSH : git@github.com:lukas2511/dehydrated.git
2. Clone with HTTPS : https://github.com/lukas2511/dehydrated.git
3. [Github地址](https://github.com/lukas2511/dehydrated)

#### 把克隆好的项目中docs/examples/目录中的config,domains.txt,hook.sh复制到项目的根目录（项目指代的是克隆下来的dehydrated）
1. 如果你会修改config参数，可以自行取消相关注释修改相关参数

2. 如果你不会修改，那么直接清空config文件，写入下面内容
```bash
#!/bin/bash

CA="https://acme-v01.api.letsencrypt.org/directory"
CHALLENGETYPE="http-01"
CERTDIR="${BASEDIR}/certs"
HOOK="${BASEDIR}/hook.sh"
CONTACT_EMAIL='你的邮箱地址，别写错了；如example@mail.com'
WELLKNOWN="/tmp/acme-wellknown"

mkdir -p $WELLKNOWN
chmod -R 777 $WELLKNOWN
```

3. 修改domains.txt(如果你会改，那么自己改...),清空里面的内容，写入下面内容
```conf
# 每一个子域名都写在后面，域名之间空一格就好（这些域名是你要配置https的域名，如果以后多了，可以继续后面加）
cool1024.com blog.cool1024 www.cool1024.com

```

4. 修改hook.sh(如果你想自动化部署，这个很重要，如果你喜欢人工操作，这里可以跳过)，在证书获取成功后的执行方法中写入下面代码（deploy_cert就是那个方法）
```bash
deploy_cert() {
    local DOMAIN="${1}" KEYFILE="${2}" CERTFILE="${3}" FULLCHAINFILE="${4}" CHAINFILE="${5}" TIMESTAMP="${6}"

    # 拷贝证书文件到项目根目录的certs文件夹下
    cp "${KEYFILE}" "${BASEDIR}/certs/"
    cp "${FULLCHAINFILE}" "${BASEDIR}/certs/";
    # 重启服务器
    nginx -s reload
    # 记录日志
    echo [`date`]执行结束 >> "${BASEDIR}/certs/log.txt"
}
```

#### 修改nginx的默认站点配置，添加一条新规则，用于证书颁发机构确认这个域名和服务器是属于你的（/etc/nginx/sites-enabled/default）
```conf
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    # 你的域名，注意这里写的是*匹配的规则，所有的子域名都会配置
    server_name *.example.com;

    # 这条规则是用来验证域名和服务器的
    location /.well-known/acme-challenge {
        alias /tmp/acme-wellknown;
    }

    # 所有的其它http请求全部重新定向到https(这个很重要，用户浏览器没有输入https我们要重定向到https的站点)
    location / {
        rewrite ^(.*)$ https://$host$request_uri permanent;
    }
}
```

#### 开始获取证书
1. 在之前克隆的项目根目录，执行项目里面的dehydrated脚本
 * 注册 `./dehydrated --register`
 * 获取证书 `./dehydrated -c`

2. 如果你出现了报错（请自己看文档，啥文档在哪里？？～～～～～这个真不适合你，去花钱买个证书吧）,一切都顺利的话你可以看的项目目录下有一个certs目录，点开目录，可以看到证书文件(fullchain.pem  privkey.pem 这两个很重要)，还有一个你域名的文件夹，里面存放了历史以来的证书

3. 好了，如果你会nginx配置https那么就到此为止咯，直接用上面的两个文件去配置吧～


#### nginx配置证书
1. 编辑这个文件`/etc/nginx/snippets/snakeoil.conf`，把原来默认的证书配置去掉，改为如下
```conf
# Self signed certificates generated by the ssl-cert package
# Don't use them in a production server!

# 这是之前生成的证书文件路径哦～
ssl_certificate /var/www/letsencrypt.sh/certs/fullchain.pem;
ssl_certificate_key /var/www/letsencrypt.sh/certs/privkey.pem;
ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
ssl_ciphers HIGH:!aNULL:!MD5;
```

2. 尝试给我的一个站点开始https
一个没有开启https的配置文件是下面这样的（使用的是80端口），我们发现配置文件中有一段443的端口配置被注释掉了
```conf
server {
        listen 80;
        listen [::]:80 default_server;

        # SSL configuration
        #
        # listen 443;
        # ssl on;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /var/www/站点的根目录;

        # Add index.php to the list if you are using PHP
        index index.html;

        server_name blog.cool1024.com;

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }
}
```
3. 把注释去掉，并写注释掉80端口的相关配置，如下，就好了
```conf
server {
        # listen 80;
        # listen [::]:80 default_server;

        # SSL configuration
        #
        listen 443;
        ssl on;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        include snippets/snakeoil.conf;

        root /var/www/站点的根目录;

        # Add index.php to the list if you are using PHP
        index index.html;

        server_name blog.cool1024.com;

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }
}
```

4. 定时任务
 * 打开控制台，输入 `crontab -e`
 * 按下 i 进入编辑模式
 * 任务书写格式如下
 ```
 * * * * * *
第1个星号表示分钟（0－59）
第2个星号表示小时（0－23）
第3个星号表示日期（0－31）
第4个星号表示月份（0－12）
第5个星号表示星期几（0－6，0是周日，6是周六）
第6个星号表示要执行的脚本文件名。

示例：
*/1 * * * * 1分钟一次
0 13 * * * 表示每天下午13点执行
30 * * * * 表示每30分钟执行
 ```
例子：`59 23 * * * /var/www/letsencrypt.sh/dehydrated -c`
<div class="tip">
1. 证书颁发机构官网[Let's Encrypt](https://letsencrypt.org)
2. 证书有效期为3个月，我们要在快要过期的时候获取一个新的（只需要重新执行./dehydrated -c）
3. 聪明的你一定写了一个定时任务（自动在快过期的时候执行证书更新）
</div>



